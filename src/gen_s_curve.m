clc; clearvars; close all;

% RUN INITIALIZATION SCRIPTS
% INITIALIZE CANTERA
% run('/Users/gpavanb/Ihme_Research/BR_Control/auto_cantera/lib/cantera/matlab/toolbox/ctpath.m');
% INITIALIZE MATCONT
run('/Users/gpavanb/Ihme_Research/BR_Control/S_Curve/matcont/init.m');

% ADD PATHS
addpath('../include/');

% INITIALIZE PSR SYSTEM
opt = Options('../data/ch4.yml');
[args,seed] = initialize_reactor(opt);

% RUN MATCONT
p=[1e-3,args];ap1=[1];
[x0,v0]=init_EP_EP(@rhs,seed,p,ap1);
opt=contset;
opt=contset(opt,'VarTolerance',1e-3);
opt=contset(opt,'FunTolerance',1e-3);
opt=contset(opt,'InitStepSize',1);
opt=contset(opt,'MinStepSize',1e-4);
opt=contset(opt,'MaxStepSize',100);
opt=contset(opt,'MaxNumPoints',200);
opt=contset(opt,'Singularities',1);
opt=contset(opt,'TSearchOrder',0);
[x,v,s,h,f]=cont(@equilibrium,x0,[],opt);
 
% PLOT S-CURVE
semilogx(x(6,:),x(5,:),'-o','LineWidth',2);
hold on;
set(gcf,'Position',[100 100 1000 850],'Color',[1 1 1]);
set(gca,'FontSize',40,'FontName','Times New Roman');
title('S-Curve');
xlabel('$\dot{m}$ $(Kg/s)$','Interpreter','Latex');
ylabel('T (K)');

% VERIFICATION
% 1-STEP (TRANS)
x2 = [0.0001, 0.00014563484775012445, 0.00021209508879201905, 0.00030888435964774815, 0.0004498432668969444, 0.0006551285568595509, 0.0009540954763499944, 0.0013894954943731374, 0.0020235896477251557, 0.0029470517025518097, 0.004291934260128779, 0.0062505519252739694, 0.009102981779915217, 0.013257113655901081, 0.019306977288832496, 0.02811768697974228, 0.040949150623804234, 0.05963623316594643, 0.08685113737513521, 0.12648552168552957, 0.18420699693267145, 0.2682695795279725, 0.3906939937054613, 0.5689866029018293, 0.8286427728546842, 1.2067926406393288, 1.7575106248547894, 2.559547922699533, 3.727593720314938, 5.428675439323859, 7.9060432109076855, 11.513953993264458, 16.768329368110066, 24.420530945486497, 35.564803062231285, 51.79474679231202, 75.43120063354607, 109.85411419875572, 159.98587196060572, 232.99518105153672, 339.3221771895323, 494.1713361323828, 719.6856730011514, 1048.1131341546852, 1526.4179671752302, 2222.996482526191, 3237.45754281764, 4714.8663634573895, 6866.488450042998, 10000.0];
y2 = [3048.918967417871, 3048.916337577902, 3048.9129613075124, 3048.908616922433, 3048.90303794432, 3048.8958719701445, 3048.8866632524882, 3048.8748321243324, 3048.859630696053, 3048.8400994850517, 3048.815003533181, 3048.7827628371133, 3048.7413351577575, 3048.6881068115563, 3048.6197144816824, 3048.5318380073095, 3048.418924146433, 3048.2738363563813, 3048.0874035423417, 3047.8478341223476, 3047.539970870734, 3047.1443232757592, 3046.635826156963, 3045.982230240688, 3045.1420370412247, 3044.061810387799, 3042.672706673639, 3040.88596009922, 3038.5869964084563, 3035.6277449468603, 3031.816463646516, 3026.904378485742, 3020.567649361764, 3012.3830926157207, 3001.7946998334633, 2988.066732440962, 2970.215887982869, 2946.909856363534, 2916.3076913808877, 2875.791537620863, 2821.472529094552, 2747.1551819372785, 2641.7009320317316, 2479.6348932336455, 2134.1438198788364, 1272.7632401782323, 1242.240387570589, 1226.492838028136, 1217.2243952144759, 1211.4239155500613];
semilogx(x2,y2,'ro','LineWidth',2,'MarkerSize',15);
xlim([1e1,1e4]);

% MARK LIMIT POINTS
semilogx([1719.389156,1539.712092],[1915.802769,1473.160705],'sg','MarkerSize',20,'MarkerFaceColor',[0 1 0]);
legend('Steady','Transient');